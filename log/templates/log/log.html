{% extends "accounts/layout.html" %}

{% block title %}Log{% endblock title %}

{% block link %}
{% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'log/log_display.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'log/modals.css' %}">
    
{% endblock link %}

{% block style %}<style></style>{% endblock style %}

{% block body %}
<header>
    <hr> 
    <h1 class="header center">MainPage || Log of: {{user}}</h1>
    <hr>
    <h2 class="header center">Latest events: </h2>

    <!-- Modal for categories-->
    <div class="modal" id="categoriesModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">Category editor</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p> Customize categories and <a class="a-empty-blue" href="">add new</a> from here: </p>
                    <button class="collapsible small-margin">Default ▼ </button>
                    <div class="content">
                        {% load filters %}
                        {% if categories %}
                        {% for category in categories %}
                        <span>
                            <p id="{{category.name}}-item" class="{{category.name}} small-margin">{{category.title}} 
                                <!-- Edit -->
                                <a id="{{category.name}}-edit-button" onclick='edit("{{category.name}}")' class="a-none">
                                    <img class="icon_button" src="{% static 'log/icons/edit.png'%}">
                                </a>

                                <span class="edit_palette" id="{{category.name}}-edit">
                                    <!-- Colorpicker -->
                                    <input class="color_picker" type="color" id="{{category.name}}-colorpicker">
                                    <!-- Tick -->
                                    <svg class="icon_button tick" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                                        <path d="M470.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L192 338.7 425.4 105.4c12.5-12.5 32.8-12.5 45.3 0z"/>
                                    </svg>
                                    <!-- Cross -->
                                    <svg class="icon_button cross" onclick='hide("{{category.name}}")' xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512">
                                        <path d="M310.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L160 210.7 54.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L114.7 256 9.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L160 301.3 265.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L205.3 256 310.6 150.6z"/>
                                    </svg>
                                    <!-- Reset -->
                                    <svg class="icon_button reset" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                                        <path d="M109.7 160H160c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32V64C0 46.3 14.3 32 32 32s32 14.3 32 32v51.2L81.6 97.6c87.5-87.5 229.3-87.5 316.8 0s87.5 229.3 0 316.8s-229.3 87.5-316.8 0c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0c62.5 62.5 163.8 62.5 226.3 0s62.5-163.8 0-226.3s-163.8-62.5-226.3 0L109.7 160z"/>
                                    </svg>
                                </span>
                                <!-- Info -->
                                <svg class="icon_button info" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512">
                                    <path d="M64 160c0-35.3 28.7-64 64-64h32c35.3 0 64 28.7 64 64v3.6c0 21.8-11.1 42.1-29.4 53.8l-42.2 27.1c-25.2 16.2-40.4 44.1-40.4 74V320c0 17.7 14.3 32 32 32s32-14.3 32-32v-1.4c0-8.2 4.2-15.8 11-20.2l42.2-27.1c36.6-23.6 58.8-64.1 58.8-107.7V160c0-70.7-57.3-128-128-128H128C57.3 32 0 89.3 0 160c0 17.7 14.3 32 32 32s32-14.3 32-32zm80 320a40 40 0 1 0 0-80 40 40 0 1 0 0 80z"/>
                                </svg>
                            </p>
                        </span>
                        {% endfor %}
                        {% endif%}
                    </div>
                    <button class="collapsible small-margin">Custom ▼ </button>

                    {% comment %} Needs some work so to say ;) {% endcomment %}
                    <div class="content">
                        {% if custom_categories %}
                        {% for category in custom_categories %}
                        <span>
                            <p class="{{category.name}} small-margin ">{{category.title}} 
                            <a href="">
                                <img class="edit_button" src="{% static 'log/edit.png'%}">
                            </a>
                            <input style="display:none" class="color_picker" type="color" id="{{category.name}}-colorpicker" value="#0000ff">
                            </p>
                        </span>
                        {% endfor %}
                        {% endif%}
                    </div>
                    
                </div>
                <!--
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Save</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Dismiss</button>
                </div>
                -->
            </div>
        </div>
    </div>

</header>

<main>
    <!-- Container for my log table || fills with load_content() function-->
    <div class="center" id="logTableContainer">
            <table id="logTable"><tbody></tbody></table>
    </div>
</main>

<footer>
    <!-- MAIN FEATURE HERE -->
    <div class="center">
        <form id="add-entry" style="display:inline-block;">
            <span>
                <!-- Value field -->
                <input required pattern="[0-9]+" name="value" id="input-value" placeholder="Value:" class="form-item">
                <!-- Category field -->
                <select name="category" id="input-category" class="form-selector">
                    {% for category in categories %}
                        {% if forloop.counter == 1 %}
                        <option selected value="{{ category.name }}">{{category.title}}</option>
                        {% else %}
                        <!-- Value should be .title for correct adding an entry -->
                        <option value="{{ category.title }}">{{category.title}}</option>
                        {% endif %}
                    {% endfor %}
                </select>
                <!-- Comment field -->
                <input name="comment" id="input-comment" placeholder="Comment:" class="form-item">
                <!-- Add button -->
                <button class="btn" type="submit">+</button>
            </span>
        </form>
    </div>
</footer>
{% endblock body %}

{% block script %}
    <script src="{% static 'log/log_management.js' %}"></script>
    {% comment %} Scripts for modal windows management {% endcomment %}
    <script>

        // Interactive colorpickers
        var colorPickers = document.getElementsByClassName("color_picker");

        for (var i = 0; i < colorPickers.length; i++) {
            colorPickers[i].addEventListener('input', function() {
                // Take this color
                let colorCode = this.value;
                // Get corresponding category
                let category = this.id.substring(0, this.id.indexOf('-')).toLowerCase();
                // Get corresponding item and set it's color to the picked one
                let item = document.getElementById(`${category}-item`);
                item.style.backgroundColor = colorCode;
            });
        };
          

        // Script for collapsible headers 
        var coll = document.getElementsByClassName("collapsible");

		for (var i = 0; i < coll.length; i++) {
			coll[i].addEventListener("click", function() {
				this.classList.toggle("active");
				var content = this.nextElementSibling;
				if (content.style.maxHeight){
                    content.style.maxHeight = null;
				} else {
                    content.style.maxHeight = content.scrollHeight + "px";
				};
                
                // Set color for colorpickers
                var colorPickers = content.querySelectorAll('.color_picker');

                colorPickers.forEach(element => {
                    let parent = element.parentNode.parentNode;
                    let color = getComputedStyle(parent).getPropertyValue('background-color');
                    element.value = rgbToHex(color);
                }); 
			});
		};

        // Transforms from rgb(x, y, z) into hexadecimal
        function rgbToHex(rgb) {
            var components = rgb.match(/\d+/g);
            var hex = '#';
            for (var i = 0; i < 3; i++) {
              var component = parseInt(components[i]).toString(16);
              hex += component.length == 1 ? '0' + component : component;
            };
            return hex;
        };
        
        // Show relevant edit palette on edit <a> click || hide edit button 
        function edit(input_category) {
            document.getElementById(input_category + "-edit").style.display = 'inline-block';
            document.getElementById(input_category + "-edit-button").style.visibility = 'hidden';
        };
        // Hide edit palette
        function hide(input_category) {
            document.getElementById(input_category + "-edit").style.display = 'none';
            document.getElementById(input_category + "-edit-button").style.visibility = 'visible';
        };

    </script>
{% endblock script %}
