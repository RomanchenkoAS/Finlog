{% extends "accounts/layout.html" %}

{% block title %}Log{% endblock title %}

{% block link %}
{% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'log/log_display.css' %}">
{% endblock link %}

{% block style %}

{% endblock style %}

{% block body %}

<h1 class="header">MainPage || Log of: {{user}}</h1>
<hr>
<h2 class="header">Latest events:</h2>
<div style="height: 300px; overflow-y: scroll; scroll-behavior: smooth; display:none" id="logTableContainer">
    <table id="logTable">
        <!-- <thead>
            <th>Value</th>
            <th>Category</th>
            <th>Datetime</th>
            <th>...</th>
        </thead> -->
        <tbody>
            {% for entry in entries %}
            <tr class="{{entry.category|lower}}" id="{{entry.position}}">
                <td>{{entry.value}}{{entry.currency}}</td>
                <td>{{entry.category}}</td>
                <td>{{entry.datetime}}</td>

                <!-- Show comment if there is one / ellipsis otherwise -->
                {% if 'comment' in entry %}
                <td>{{entry.comment}}</td>
                {% else %}
                <td>...</td>
                {% endif %}

                <td>
                    <button type="button" class="btn delete" id="{{entry.position}}-remove" onclick="deleteEntry({{entry.position}})">
                        <span>
                            &times;
                        </span>
                    </button>
                </td>

            </tr>
            {% endfor %}

        </tbody>
    </table>
</div>

<!-- MAIN FEATURE HERE -->
<form id="add-entry" style="display:inline-block;">
        <!-- Value field -->
        <input name="value" id="input-value" placeholder="Value:">
        <!-- Category field -->
        <select name="category" id="input-category" class="form-select">
            {% for category in categories %}
                {% if forloop.counter == 1 %}
                <option selected value="{{ category }}">{{category}}</option>
                {% else %}
                <option value="{{ category }}">{{category}}</option>
                {% endif %}
            {% endfor %}
        </select>
        <!-- Comment field -->
        <input name="comment" id="input-comment" placeholder="Comment:">
        <!-- Add button -->
        <button class="btn" type="submit">+</button>
</form>

{% endblock body %}

{% block script %}
<script>
    
    // Manually (first - showing and then) scrolling down the table
    function ScrollDown() {
        var tableContainer = document.getElementById("logTableContainer");
        tableContainer.style.display = "block";
        tableContainer.scrollTop = tableContainer.scrollHeight;
    }

    // Script to delete an entry with given entry.position
    function deleteEntry(pos) {
        console.log(`I am to delete an entry #${pos}`);

        fetch(`/remove/${pos}/`, {
            method : 'DELETE',
            headers : {
                'Content-Type' : 'application/JSON'
            },
            body: JSON.stringify({
                position: pos 
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Not ok response');
            }
            // Now actually remove from the page
            var row = document.getElementById(`${pos}`)
            
            row.style['display'] = 'none'
        })
        .catch(error => {
            console.error('Issue with fetch operation: ', error);
        });
    };

    // Adding a new entry
    $('#add-entry').on("submit", function(event) {
        event.preventDefault();

        // Get form fields values into vars
        let value = document.querySelector('#input-value').value;
        let category = document.querySelector('#input-category').value;
        let comment = document.querySelector('#input-comment').value;

        //console.log('Submitted data serialized:');
        //console.log($(this).serialize());


        // get the form data and send an AJAX request to the server
        $.ajax({
            url: 'add',
            type: 'POST',
            data: $(this).serialize(),
            success: function(data) {
                // update the list on the page with the new data
                var lastItem = data.entries[data.entries.length - 1];

                var table   = document.getElementById('logTable');
                var newrow  = table.insertRow();

                // Cells variables
                var cellValue       = newrow.insertCell(0);
                var cellCategory    = newrow.insertCell(1);
                var cellDate        = newrow.insertCell(2);
                var cellComment     = newrow.insertCell(3);
                var cellDelButton   = newrow.insertCell(4);

                // Populate the cells
                cellValue.innerHTML = lastItem.value;
                cellCategory.innerHTML = lastItem.category;
                cellDate.innerHTML = lastItem.date;
                cellComment.innerHTML = lastItem.comment;
                cellDelButton.innerHTML = '&times;';
                // Making it of the right class 
                newrow.classList.add(lastItem.category.toLowerCase());

                // Manual scroll down
                ScrollDown();
            },
            error: function() {
                alert('Error adding entry.');
            }
        });

    });


    // Scroll table to bottom on page load
    window.onload = function() {
        ScrollDown();
    }

</script>
{% endblock script %}