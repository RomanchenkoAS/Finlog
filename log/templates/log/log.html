{% extends "accounts/layout.html" %}

{% block title %}Log{% endblock title %}

{% block link %}
{% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'log/log_display.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'log/modals.css' %}">
    
{% endblock link %}

{% block style %}<style></style>{% endblock style %}

{% block body %}
<header>
    <hr> 
    <h1 class="header center">MainPage || Log of: {{user}}</h1>
    <hr>
    <h2 class="header center">Latest events: </h2>

    <!-- Modal for categories-->
    <div class="modal" id="categoriesModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">Category editor</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p> Customize categories and <a class="a-empty-blue" onclick="expand_custom()">add new</a> from here: </p>
                    <button class="collapsible small-margin">Default ▼ </button>
                    <div class="content" id="default_categories_container">
                        {% load filters %}
                        {% if categories %}
                        {% for category in categories %}
                        <span>
                            <p id="{{category.name}}-item" data-color="{{category.color}}" style="background-color:{{category.color}}" class="category small-margin">{{category.title}} 
                                <!-- Edit -->
                                <a id="{{category.name}}-edit-button" class="a-none" onclick="expand('{{category.name}}')" >
                                    <img class="icon_button" src="{% static 'log/icons/edit.png'%}">
                                </a>

                                <span class="edit_palette" id="{{category.title}}-edit">
                                    <!-- Colorpicker -->
                                    <input class="color_picker" type="color" id="{{category.title}}-colorpicker">
                                    <!-- Tick -->
                                    <a onclick="edit('{{category.title}}')" class="a-none">
                                        <img class="icon_button" src="{% static 'log/icons/tick.svg'%}">
                                    </a>
                                    <!-- Cross -->
                                    <a onclick='hide("{{category.name}}")' class="a-none">
                                        <img class="icon_button" src="{% static 'log/icons/cross.svg'%}">
                                    </a>
                                    <!-- Reset -->
                                    <a onclick='' class="a-none">
                                        <img class="icon_button" src="{% static 'log/icons/reset.svg'%}">
                                    </a>
                                </span>
                                <!-- Info -->
                                <a onclick='' class="a-none">
                                    <img class="icon_button" src="{% static 'log/icons/info.svg'%}">
                                </a>
                            </p>
                        </span>
                        {% endfor %}
                        {% endif%}
                    </div>
                    <button class="collapsible small-margin" id="collapsible_custom">Custom ▼ </button>

                    <!-- Custom block -->
                    <div class="content" id="custom_categories_container">
                        {% if user_categories %}
                        {% for category in user_categories %}
                        <!-- Existing user categories -->
                        <span>
                            <p id="{{category.name}}-item" data-color="{{category.color}}" style="background-color:{{category.color}}" class="category small-margin">{{category.title}} 
                                <a id="{{category.name}}-edit-button" class="a-none" onclick="expand('{{category.name}}')" >
                                    <img class="icon_button" src="{% static 'log/icons/edit.png'%}">
                                </a>
                                <span class="edit_palette" id="{{category.name}}-edit">
                                    <!-- Input name field -->
                                    <input class="change_name" type="text" id="{{category.name}}-newname" value="{{category.name}}"> 
                                    <!-- Colorpicker -->
                                    <input class="color_picker" type="color" id="{{category.name}}-colorpicker">
                                    <!-- Tick -->
                                    <a onclick="edit('{{category.title}}')" class="a-none">
                                        <img class="icon_button" src="{% static 'log/icons/tick.svg'%}">
                                    </a>
                                    <!-- Cross -->
                                    <a onclick='hide("{{category.name}}")' class="a-none">
                                        <img class="icon_button" src="{% static 'log/icons/cross.svg'%}">
                                    </a>
                                    <!-- Delete -->
                                    <a onclick='edit("{{category.name}}", "delete")' class="a-none">
                                        <img class="icon_button" src="{% static 'log/icons/delete.svg'%}">
                                    </a>
                                </span>
                            </p>
                        </span>
                        {% endfor %}
                        {% endif %}
                        <!-- Create new category -->
                        <span >
                            <p id="add-item" style="background-color:#d3d3d3" class="category small-margin">Create new category
                                <!-- Edit -->
                                <a id="add-edit-button" onclick='expand("add")' class="a-none">
                                    <img class="icon_button" src="{% static 'log/icons/plus.svg'%}">
                                </a>

                                <span class="edit_palette" id="add-edit">
                                    <!-- Input name field -->
                                    <input class="change_name" type="text" id="add-newname"> 
                                    <!-- Colorpicker -->
                                    <input class="color_picker" type="color" id="add-colorpicker" value="#d3d3d3">
                                    <!-- Tick -->
                                    <!-- Edit syntax is edit(categoryName, action)-->
                                    <a onclick='edit("add", "add")' class="a-none">
                                        <img class="icon_button" src="{% static 'log/icons/tick.svg'%}">
                                    </a>
                                    <!-- Cross -->
                                    <a onclick='hide("add")' class="a-none">
                                        <img class="icon_button" src="{% static 'log/icons/cross.svg'%}">
                                    </a>
                                </span>
                            </p>
                        </span>
                    </div>
                    
                </div>
                <!--
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Save</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Dismiss</button>
                </div>
                -->
            </div>
        </div>
    </div>

</header>

<main>
    <!-- Container for my log table || fills with load_content() function-->
    <div class="center" id="logTableContainer">
            <table id="logTable"><tbody></tbody></table>
    </div>
</main>

<footer>
    <!-- MAIN FEATURE HERE -->
    <div class="center">
        <form id="add-entry">
            <span>
                <!-- Value field -->
                <input required pattern="[0-9]+" name="value" id="input-value" placeholder="Value:" class="form-item">
                <!-- Category field -->
                <select name="category" id="input-category" class="form-selector">
                    {% for category in categories %}
                    {% if forloop.counter == 1 %}
                    <!-- Value should be .title for correctly adding an entry -->
                        <option selected value="{{ category.title }}">{{category.title}}</option>
                        {% else %}
                        <option value="{{ category.title }}">{{category.title}}</option>
                        {% endif %}
                    {% endfor %}
                    <!-- User categories -->
                    {% for category in user_categories %}
                        <option value="{{ category.title }}">{{category.title}}</option>
                    {% endfor %}
                </select>
                <!-- Comment field -->
                <input name="comment" id="input-comment" placeholder="Comment:" class="form-item">
                <!-- Add button -->
                <button class="btn" type="submit">
                    <img class="icon_button" src="{% static 'log/icons/plus.svg'%}">
                </button>
            </span>
        </form>
    </div>
</footer>
{% endblock body %}

{% block script %}
    <script src="{% static 'log/log_management.js' %}"></script>
    {% comment %} Scripts for modal windows management {% endcomment %}
    <script>
        
        // Interactive colorpickers
        var colorPickers = document.getElementsByClassName("color_picker");
        
        for (var i = 0; i < colorPickers.length; i++) {
            colorPickers[i].addEventListener('input', function() {
                // Take this color
                let colorCode = this.value;
                // Get corresponding category by cutting off '-colorpicker'
                let category = this.id.substring(0, this.id.indexOf('-colorpicker'));
                // Get corresponding item and set it's color to the picked one
                let item = document.getElementById(`${category}-item`);
                
                // Also change all the relevant itmes to a new color
                item.style.backgroundColor = colorCode;

                // All cells
                const cells = document.querySelectorAll("td");
                // All cells with category written there
                const cellsToChange = Array.from(cells).filter(cell => cell.textContent.includes(category));

                // And then changing their parent's color 
                cellsToChange.forEach(item => {
                    item.parentElement.style.backgroundColor = colorCode;
                });
            });
        };
          

        // Script for collapsible headers 
        var coll = document.getElementsByClassName("collapsible");

		for (var i = 0; i < coll.length; i++) {
            coll[i].addEventListener("click", function() {
                this.classList.toggle("active");
				var content = this.nextElementSibling;
				if (content.style.maxHeight){
                    content.style.maxHeight = null;
				} else {
                    content.style.maxHeight = content.scrollHeight + "px";
				};
                
                // Set color for colorpickers
                var colorPickers = content.querySelectorAll('.color_picker');
                
                colorPickers.forEach(element => {
                    let parent = element.parentNode.parentNode;
                    let color = getComputedStyle(parent).getPropertyValue('background-color');
                    element.value = rgbToHex(color);
                }); 
			});
		};
        
        // Show 'custom' collapsible header 
        var custom = document.getElementById("collapsible_custom");
        var customHeaderContent = custom.nextElementSibling;

        function expand_custom() {
            //console.log('showing custom')
            custom.classList.toggle("active");
            if (customHeaderContent.style.maxHeight){
                customHeaderContent.style.maxHeight = null;
            } else {
                customHeaderContent.style.maxHeight = customHeaderContent.scrollHeight + "px";
            };
        }
        

        // Transforms from rgb(x, y, z) into hexadecimal
        function rgbToHex(rgb) {
            var components = rgb.match(/\d+/g);
            var hex = '#';
            for (var i = 0; i < 3; i++) {
                var component = parseInt(components[i]).toString(16);
                hex += component.length == 1 ? '0' + component : component;
            };
            return hex;
        };
        
        // Show relevant edit palette on edit <a> click || hide edit button 
        function expand(input_category) {
            document.getElementById(input_category + "-edit").style.display = 'inline-block';
            document.getElementById(input_category + "-edit-button").style.visibility = 'hidden';
        };
        // Hide edit palette
        function hide(input_category) {
            document.getElementById(input_category + "-edit").style.display = 'none';
            document.getElementById(input_category + "-edit-button").style.visibility = 'visible';

            let paragraph = document.getElementById(input_category + "-item");
            let previousColor = paragraph.dataset.color;
            let color_picker = document.getElementById(input_category + "-colorpicker");

            color_picker.value = previousColor;
            paragraph.style.backgroundColor = previousColor;

            // Also change all the relevant itmes to the previous color

            // All cells
            const cells = document.querySelectorAll("td");
            // All cells with category written there
            const cellsToChange = Array.from(cells).filter(cell => cell.textContent.includes(input_category));

            // And then changing their parent's color 
            cellsToChange.forEach(item => {
                item.parentElement.style.backgroundColor = previousColor;
            });

        };
        
        // Variable that controls behaviour of the page after closing the modal window
        let called_action = 'none';

        function edit(input_category, action = 'edit') {
            let colorPicker = document.getElementById(input_category + "-colorpicker");
            
            // Action options: edit | add | delete | reset
            name = input_category;
            color = colorPicker.value;
            
            let name_input = document.getElementById(`${input_category}-newname`);
            if (name_input != null) {
                newname = name_input.value;
            } else {
                newname = name;
            };

            if (newname != name && action == 'edit') {
                action = 'rename';
            };

            console.log(`${action} ${input_category} | new color: ${colorPicker.value} | |new name: ${newname} | sending xhr request`);

            // send actual request at /edit/
            var xhr = new XMLHttpRequest();
            var url = "/edit/";
            xhr.open("POST", url, true);
            xhr.setRequestHeader("Content-Type", "application/json");

            // In case we need response json 
            /*
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    var json = JSON.parse(xhr.responseText);
                    console.log(json);
                }
            }; */

            // Simple ok response
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 204) {
                    console.log("Request successful");

                    called_action = action;

                    // If there was a new category added, spawn it right there
                    if (action == 'add') {
                        let container = document.getElementById("user_categories_container");
                        let newSpan = document.createElement("span");
                        let newParagraph = document.createElement("p");

                        newParagraph.textContent = newname;
                        newParagraph.style.backgroundColor = color;
                        newParagraph.className = 'category small-margin';

                        newSpan.appendChild(newParagraph);

                        let index = container.children.length - 1;
                        let previousParagraph = container.children[index];
                        container.insertBefore(newSpan, previousParagraph);

                        // Expand the header to contain one more line
                        customHeaderContent.style.maxHeight = customHeaderContent.scrollHeight + "px";

                        var content = custom.nextElementSibling;
                        if (content.style.maxHeight){
                            content.style.maxHeight = null;
                        } else {
                            content.style.maxHeight = content.scrollHeight + "px";
                        };

                        // TODO: maybe add edit_palette here as well?
                        // Not necessary though
                    };

                    if (action == 'delete') {
                        deleted = document.getElementById(`${name}-item`)
                        // Yeah looks weird, works though
                        deleted.parentElement.removeChild(deleted);
                    };

                    if (action == 'rename') {
                        // Change existing category inside modal window
                        document.getElementById(`${name}-item`).textContent = newname;
                        
                        // Change category name for entries
                        // All cells
                        const cells = document.querySelectorAll("td");
                        // All cells with category written there
                        const cellsToChange = Array.from(cells).filter(cell => cell.textContent.includes(name));

                        // And then changing text wtitten there
                        cellsToChange.forEach(item => {
                            item.textContent = newname;
                        });
                        
                        // Change category name in select
                        const select = document.querySelectorAll("option");
                        const selectToChange = Array.from(select).filter(select => select.value.includes(name));
                        selectToChange[0].value = newname;
                        selectToChange[0].textContent = newname;
                    };
                };
            };

            // Sending data
            var data = JSON.stringify({"name": name, "color": color, "action": action, "newname": newname});
            xhr.send(data);
            
            // Hide edit palette
            hide(input_category);
        };
        
        // TODO: Dissmiss all the changes on closing the modal
        var categoriesModal = document.getElementById("categoriesModal");
        
        categoriesModal.addEventListener("hidden.bs.modal", function () {
            
            // If a new category was added - refresh the page
            if (called_action == 'add' || called_action == 'delete' || called_action == 'rename') {
                location.reload();
            } else {
                // Unexpand all the pallettes
                def_container = document.getElementById('default_categories_container');
                cust_container = document.getElementById('custom_categories_container');

                console.log(def_container)
                console.log(cust_container)
                console.log(def_container.childNodes)
                console.log(cust_container.childNodes)

                def_nodes = def_container.childNodes;
                cust_nodes = cust_container.childNodes;

                def_spans = Array.from(def_nodes).filter(node => node.nodeName === 'SPAN')
                cust_spans = Array.from(cust_nodes).filter(node => node.nodeName === 'SPAN')

                console.log(def_spans)
                console.log(cust_spans)

                def_spans.forEach(element => {
                    console.log(element);
                    let category = inputField[i].id.slice(0, inputField[i].id.indexOf('-newname'));
                    //hide("")
                })
                cust_spans.forEach(element => {
                    console.log(element);
                    //hide("")
                })


            };
        });
        
        // Event listeners for space/enter on category name input
        const inputField = document.getElementsByClassName('change_name');
        for (let i=0; i < inputField.length; i++) {
            inputField[i].addEventListener('keydown', (event) => {
                //console.log(inputField[i]);
                if (event.code === 'Space') {
                    event.preventDefault();
                };

                if (event.code === 'Enter') {

                    if (inputField[i].id == 'add-newname') {
                        edit("add", "add");
                    } else {
                        // Cut off category part from the string
                        let category = inputField[i].id.slice(0, inputField[i].id.indexOf('-newname'));
                        edit(category, "edit");
                    };


                };
            });

        };



    </script>
    {% endblock script %}
